name: Jarvis PR Bridge

on:
  workflow_dispatch:
    inputs:
      plan_path:
        description: 'Path to the JSON plan file'
        required: false
        default: 'tools/jarvis/change.json'
        type: string

jobs:
  create-pr:
    name: Create PR via Jarvis Bridge
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Validate required secrets
        env:
          APP_ID: ${{ secrets.JARVIS_APP_ID }}
          INSTALLATION_ID: ${{ secrets.JARVIS_INSTALLATION_ID }}
          PRIVATE_KEY: ${{ secrets.JARVIS_APP_PRIVATE_KEY }}
        run: |
          echo "üîç Validating required secrets..."
          
          if [ -z "$APP_ID" ]; then
            echo "‚ùå ERROR: JARVIS_APP_ID secret is not set"
            exit 1
          fi
name: Jarvis Bridge

on:
  # Primary: event-driven (fires immediately)
  issues:
    types: [opened, edited, reopened, labeled]
  issue_comment:
    types: [created]

  # Fallbacks
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: jarvis-bridge
  cancel-in-progress: false

jobs:
  bridge:
    runs-on: ubuntu-latest
    steps:
      - name: Heartbeat (never skips)
        run: |
          echo "JARVIS_BRIDGE_HEARTBEAT"
          echo "event=${{ github.event_name }}"
          echo "ref=${{ github.ref }}"
          echo "repo=${{ github.repository }}"
          date -u

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install deps (if present)
        run: |
          if [ -f package-lock.json ] || [ -f npm-shrinkwrap.json ]; then
            npm ci
          elif [ -f package.json ]; then
            npm install
          else
            echo "No package.json found, continuing."
          fi

      - name: Run Jarvis Bridge
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_REF: ${{ github.ref }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_SHA: ${{ github.sha }}
        run: |
          if [ -f ./scripts/jarvis-bridge.js ]; then
            node ./scripts/jarvis-bridge.js
          elif [ -f ./jarvis-bridge.js ]; then
            node ./jarvis-bridge.js
          else
            echo "ERROR: jarvis bridge script not found."
            exit 1
          fi
