name: Jarvis Prompt Inbox

on:
  schedule:
    # Run every 15 minutes
    - cron: '*/15 * * * *'
  workflow_dispatch:

jobs:
  process-prompt-inbox:
    name: Process Prompt Inbox Issues
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      issues: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Find jarvis:do issues
        id: find_issues
        uses: actions/github-script@v7
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'jarvis:do',
              state: 'open'
            });
            
            console.log(`Found ${issues.data.length} jarvis:do issues`);
            
            // Filter out issues that already have PR links in comments
            const unprocessedIssues = [];
            for (const issue of issues.data) {
              const comments = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number
              });
              
              const hasProcessedComment = comments.data.some(comment => 
                comment.body.includes('ü§ñ Jarvis PR Generated') ||
                comment.user.login === 'github-actions[bot]'
              );
              
              if (!hasProcessedComment) {
                unprocessedIssues.push(issue);
              }
            }
            
            console.log(`${unprocessedIssues.length} unprocessed issues`);
            
            return unprocessedIssues;
      
      - name: Process each issue
        if: steps.find_issues.outputs.result != '[]'
        uses: actions/github-script@v7
        env:
          JARVIS_APP_ID: ${{ secrets.JARVIS_APP_ID }}
          JARVIS_INSTALLATION_ID: ${{ secrets.JARVIS_INSTALLATION_ID }}
          JARVIS_APP_PRIVATE_KEY: ${{ secrets.JARVIS_APP_PRIVATE_KEY }}
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const issues = ${{ steps.find_issues.outputs.result }};
            
            for (const issue of issues) {
              console.log(`\nüìã Processing issue #${issue.number}: ${issue.title}`);
              
              try {
                // Generate a plan from the issue
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').split('T')[0] + '-' + Date.now();
                const planPath = `tools/jarvis/plans/PLAN-issue-${issue.number}-${timestamp}.json`;
                
                // Parse issue body to extract requirements
                const issueBody = issue.body || '';
                
                // Create a simple plan structure
                const plan = {
                  title: `Implement: ${issue.title}`,
                  description: `Automated PR generated from issue #${issue.number}`,
                  branch: `jarvis/issue-${issue.number}-${Date.now()}`,
                  changes: [
                    {
                      type: 'create',
                      path: `docs/automated/issue-${issue.number}.md`,
                      content: `# Implementation for Issue #${issue.number}\n\n## Title\n${issue.title}\n\n## Description\n${issueBody}\n\n## Status\nThis is an automated implementation request.\n\n---\nGenerated by Jarvis Prompt Inbox\n`
                    }
                  ]
                };
                
                // Ensure directory exists
                const planDir = path.dirname(planPath);
                if (!fs.existsSync(planDir)) {
                  fs.mkdirSync(planDir, { recursive: true });
                }
                
                // Write plan file
                fs.writeFileSync(planPath, JSON.stringify(plan, null, 2));
                console.log(`‚úÖ Created plan: ${planPath}`);
                
                // Use GitHub API to commit the plan file (safer than shell commands)
                const fileContent = Buffer.from(JSON.stringify(plan, null, 2)).toString('base64');
                
                // Get the default branch
                const repoData = await github.rest.repos.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo
                });
                const defaultBranch = repoData.data.default_branch;
                
                await github.rest.repos.createOrUpdateFileContents({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  path: planPath,
                  message: `Add Jarvis plan for issue #${issue.number}`,
                  content: fileContent,
                  branch: defaultBranch
                });
                
                console.log(`‚úÖ Committed plan via GitHub API`);
                
                // Trigger the PR bridge workflow
                await github.rest.actions.createWorkflowDispatch({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  workflow_id: 'jarvis-pr-bridge.yml',
                  ref: 'main',
                  inputs: {
                    plan_path: planPath
                  }
                });
                
                console.log(`‚úÖ Triggered PR bridge workflow`);
                
                // Poll for PR creation with retry logic (up to 2 minutes)
                let prFound = false;
                let matchingPR = null;
                const maxAttempts = 8; // 8 attempts with 15 seconds each = 2 minutes
                const pollInterval = 15000; // 15 seconds
                
                for (let attempt = 0; attempt < maxAttempts && !prFound; attempt++) {
                  await new Promise(resolve => setTimeout(resolve, pollInterval));
                  
                  console.log(`Checking for PR (attempt ${attempt + 1}/${maxAttempts})...`);
                  
                  const prs = await github.rest.pulls.list({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    state: 'open',
                    sort: 'created',
                    direction: 'desc',
                    per_page: 10
                  });
                  
                  matchingPR = prs.data.find(pr => 
                    pr.head.ref.includes(`issue-${issue.number}`)
                  );
                  
                  if (matchingPR) {
                    prFound = true;
                    console.log(`‚úÖ Found PR #${matchingPR.number}`);
                  }
                }
                
                if (matchingPR) {
                  // Comment on the issue with the PR link
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issue.number,
                    body: `ü§ñ **Jarvis PR Generated**\n\nI've created a pull request to address this issue:\n\nüîó **PR Link:** #${matchingPR.number}\n\nüìã **Plan File:** \`${planPath}\`\n\nThe PR is ready for review. Please review and merge when satisfied.\n\n---\n*This is an automated response from Jarvis Prompt Inbox.*`
                  });
                  
                  console.log(`‚úÖ Commented on issue #${issue.number} with PR link`);
                  
                  // Add a label to mark as processed
                  await github.rest.issues.addLabels({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issue.number,
                    labels: ['jarvis:processing']
                  });
                  
                  console.log(`‚úÖ Added 'jarvis:processing' label to issue #${issue.number}`);
                } else {
                  console.log(`‚ö†Ô∏è Could not find matching PR for issue #${issue.number}`);
                  
                  // Comment that we couldn't find the PR
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issue.number,
                    body: `ü§ñ **Jarvis Processing**\n\nI've triggered a workflow to create a PR for this issue, but I couldn't verify the PR was created successfully.\n\nPlease check the Actions tab for the workflow status.\n\nüìã **Plan File:** \`${planPath}\`\n\n---\n*This is an automated response from Jarvis Prompt Inbox.*`
                  });
                }
                
              } catch (error) {
                console.error(`‚ùå Error processing issue #${issue.number}:`, error);
                
                // Comment on the issue about the error
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: `ü§ñ **Jarvis Error**\n\nI encountered an error while processing this issue:\n\n\`\`\`\n${error.message}\n\`\`\`\n\nPlease check the issue description and try again, or contact a maintainer.\n\n---\n*This is an automated response from Jarvis Prompt Inbox.*`
                });
              }
            }
            
            if (issues.length === 0) {
              console.log('‚úÖ No unprocessed jarvis:do issues found');
            }
